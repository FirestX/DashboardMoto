@page "/scatter-plot"
@using Models
@using Services
@inject IHttpClientFactory HttpClientFactory
@rendermode InteractiveServer

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Price vs Mileage by Brand</MudText>
    
    @if (Motorbikes is null)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        <MudText>Loading motorcycle data...</MudText>
    }
    else if (!Motorbikes.Any())
    {
        <MudAlert Severity="Severity.Info">No motorcycle data available.</MudAlert>
    }
    else
    {
        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-3">Select Brands to Display</MudText>
            <MudGrid Class="mb-4">
                @foreach (var brand in AvailableBrands)
                {
                    <MudItem xs="6" sm="4" md="3" lg="2">
                        <MudCheckBox T="bool" 
                                     Value="@SelectedBrands.Contains(brand)" 
                                     ValueChanged="@(async (bool value) => await OnBrandToggled(brand, value))"
                                     Label="@brand"
                                     Color="Color.Primary" />
                    </MudItem>
                }
            </MudGrid>
            
            <MudDivider Class="mb-4" />
            
            <MudChart 
                ChartType="ChartType.Line" 
                ChartSeries="@Series" 
                XAxisLabels="@XAxisLabels"
                Width="100%" 
                Height="500px"
                ChartOptions="@_chartOptions">
            </MudChart>
            
            <MudText Typo="Typo.body2" Class="mt-4">
                Total Motorcycles: @Motorbikes.Count() | 
                Brands Displayed: @SelectedBrands.Count
            </MudText>
        </MudPaper>
    }
</MudContainer>

@code {
    private IEnumerable<Motorbike>? Motorbikes { get; set; }
    private List<ChartSeries> Series { get; set; } = new();
    private string[] XAxisLabels { get; set; } = Array.Empty<string>();
    private List<string> AvailableBrands { get; set; } = new();
    private HashSet<string> SelectedBrands { get; set; } = new();
    
    private ChartOptions _chartOptions = new ChartOptions
    {
        YAxisTicks = 10,
        YAxisLines = true,
        XAxisLines = true,
        LineStrokeWidth = 2,
        InterpolationOption = InterpolationOption.Straight
    };

    private string[] _brandColors = new[]
    {
        "#FF6B6B", "#4ECDC4", "#FF0000", "#FF8C42", "#C44569",
        "#00B894", "#F97F51", "#5F27CD", "#00D2D3", "#0984E3",
        "#6C5CE7", "#FD79A8", "#FDCB6E", "#A29BFE", "#E17055",
        "#74B9FF", "#B2BEC3"
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Motorbikes = await RequestService.GetMotorbikesRequest(HttpClientFactory);
            
            if (Motorbikes != null && Motorbikes.Any())
            {
                AvailableBrands = Motorbikes
                    .Where(m => m.Price > 0 && m.MileageKm > 0)
                    .Select(m => m.Brand.ToString())
                    .Distinct()
                    .OrderBy(b => b)
                    .ToList();
                
                SelectedBrands = AvailableBrands.Take(10).ToHashSet();
                
                PrepareLineGraphData();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading motorcycles: {ex.Message}");
        }
    }

    private Task OnBrandToggled(string brand, bool isChecked)
    {
        if (isChecked)
        {
            SelectedBrands.Add(brand);
        }
        else
        {
            SelectedBrands.Remove(brand);
        }
        
        PrepareLineGraphData();
        StateHasChanged();
        return Task.CompletedTask;
    }

    private void PrepareLineGraphData()
    {
        if (Motorbikes == null || !SelectedBrands.Any()) return;
        
        var brandGroups = Motorbikes
            .Where(m => m.Price > 0 && m.MileageKm > 0 && SelectedBrands.Contains(m.Brand.ToString()))
            .GroupBy(m => m.Brand.ToString())
            .OrderBy(g => g.Key)
            .ToList();
        
        var allMileages = brandGroups
            .SelectMany(g => g.Select(m => m.MileageKm))
            .OrderBy(m => m)
            .ToList();
        
        var mileageStep = (int)((allMileages.Max() - allMileages.Min()) / 20);
        var mileagePoints = Enumerable.Range(0, 21)
            .Select(i => allMileages.Min() + (i * mileageStep))
            .ToList();
        
        XAxisLabels = mileagePoints.Select(m => $"{m / 1000}k").ToArray();
        
        Series = new List<ChartSeries>();
        _chartOptions.ChartPalette = _brandColors;
        
        foreach (var brandGroup in brandGroups)
        {
            var brandData = new double[mileagePoints.Count];
            
            for (int i = 0; i < mileagePoints.Count; i++)
            {
                var bike = brandGroup
                    .OrderBy(m => Math.Abs(m.MileageKm - mileagePoints[i]))
                    .FirstOrDefault();
                
                brandData[i] = bike?.Price ?? 0;
            }
            
            Series.Add(new ChartSeries
            {
                Name = brandGroup.Key,
                Data = brandData
            });
        }
    }
}
